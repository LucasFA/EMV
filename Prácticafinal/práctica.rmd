---
title: "Pr치ctica final"
author: "Agnese, Lucas Fehlau Arbulu"
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: true
    toc_depth: 3
    number_sections: false
    toc_float: 
      collapsed: false
      smooth_scroll: false
  pdf_document: default
    keep_tex: true
---

<!-- Load data from csv file -->
```{r}
data <- read.csv("./diabetes.csv", stringsAsFactors = TRUE)
str(data)
```

# An치lisis exploratorio univariante

<!-- TBD -->

## An치lisis exploratorio multivariante

Eliminamos la variable respuesta categ칩rica
```{r}
data_no_output <- subset(data, select = -class)
```
<!-- a) -->
Y comprobamos si tiene sentido aplicar PCA con el test de Bartlett
```{r}
cor(data_no_output)
library(psych)
data_normalised <- scale(data_no_output)
cortest.bartlett(cor(data_normalised))
```
<!-- b hecho? TODO -->
<!-- c hecho? TODO -->

<!-- Before d and e -->

<!-- ### Preparation for PCA and FA

We check that the data is  -->
<!-- d) -->
Actual PCA
```{r}
PCA <- prcomp(data_no_output, scale = TRUE, center = TRUE)

PCA$rotation

plot(cumsum(PCA$sdev^2) / (sum(PCA$sdev^2)), type = "l") # check this
summary(PCA)
```
### Choosing the number of components
We need the function `fviz_screeplot` from the `factoextra` package.

```{r}
library(factoextra)
```

#### Elbow method
```{r}
fviz_screeplot(PCA, addlabels = TRUE)
```
Suggests 3 components
### Mean variace method
```{r}
PCA$sdev
mean(PCA$sdev^2)
```
Also suggests 3 components.

<!-- TODO: where does this go? It doesn't seem to appear in the guide -->
### Visualization of principal components
```{r}
fviz_pca_var(PCA,
        repel = TRUE, col.var = "cos2",
        legend.title = "Distancia"
) + theme_bw()
```

```{r}
fviz_pca_var(PCA,
        axes = c(1, 3),
        repel = TRUE, col.var = "cos2",
        legend.title = "Distancia"
) + theme_bw()
```

<!-- TODO?: interpretation -->

<!-- e) -->
## Factor analysis
### Preconditions
We saw in our previous analysis of correlations for PCA that the data 

```{r}
poly_cor <- polycor::hetcor(data_no_output)$correlations
ggcorrplot::ggcorrplot(poly_cor, type = "lower", hc.order = T)
```

```{r}
corrplot::corrplot(cor(data_no_output), order = "hclust", tl.col = "black", tl.cex = 1)
```

### Actual FA

MLE model:
```{r}
modelo1 <- fa(poly_cor,
  nfactors = 3,
  rotate = "none",
  fm = "mle"
)
```
Minimum residual model:
```{r}
modelo2 <- fa(poly_cor,
  nfactors = 3,
  rotate = "none",
  fm = "minres"
)
```
Compare the communalities
```{r }
c1 <- sort(modelo1$communality, decreasing = T)
c2 <- sort(modelo2$communality, decreasing = T)
head(cbind(c1, c2))
```

<!-- TODO: check the name of this -->
Compare the unicities 

```{r }
u1 <- sort(modelo1$uniquenesses, decreasing = T)
u2 <- sort(modelo2$uniquenesses, decreasing = T)
head(cbind(u1, u2))
```

<!-- f -->

## Classifier